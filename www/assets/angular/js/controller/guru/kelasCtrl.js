angular.module("RdmApp").controller("kelasCtrl",["$cookies","$scope","$rootScope","$stateParams","common","DTOptionsBuilder","DTColumnBuilder","$http","$q","ApiServer",function(a,i,n,o,l,e,t,k,p,r){n.dataharian=[],n.dataketerampilan=[],n.bobot=[],n.kkmdata=[],n.selectKelas=o.idkelas,a.put("selectkelas",n.selectKelas),n.getbobotkelas=function(){r.get("guru/kelas/bobot",(function(a){n.kkmdata=a.data,n.bobot=a.bobot,0==n.kkmdata.length?Swal.fire({type:"error",title:"Gagal",showConfirmButton:!0,html:"KKM Tingkat belum di isi oleh admin madrasah."}):(n.getharian(),n.getketerampilan())}))},n.getbobotkelas(),n.updateSikap=function(){"0"!==n.datakelasSelect.mapel_jenisnilai&&void 0!==n.datakelasSelect.mapel_jenisnilai&&i.getSikap(n.datakelasSelect.mapel_jenisnilai)},i.getSikap=function(a){$.blockUI({}),r.get("guru/sikap/datasikap/"+a,(function(a){$.unblockUI({}),n.datasikap=[],n.datakomponensikap=a.komponen,n.datanilaisikap=a.datanilai,n.jenisnilai=a.jenisnilai,angular.forEach(n.datasiswa,(function(a){var o=!1;"1"==n.datakelasSelect.mapel_pilihan&&(i.FilPilihan=n.siswapilihan.filter((function(i){return i.siswa_id==a.siswa_id})),i.FilPilihan.length>0&&(o=!0)),"0"!=n.datakelasSelect.mapel_pilihan&&1!=o||n.datasikap.push(a)})),n.jnilai=0,angular.forEach(n.jenisnilai,(function(a){a.cnilai>0&&n.jnilai++}))}))},i.filterKelas=function(){n.datakelasSelect=[],i.filterdata=n.datakelas.filter((function(a){return a.ajar_id==n.selectKelas})),i.filterdata.length>0&&(n.datakelasSelect=i.filterdata[0])},i.filterKelas(),i.$on("KelasChange",(function(a,n){n.length>0&&i.filterKelas()})),i.getdatasiswa=function(){r.get("guru/kelas/datasiswa",(function(a){n.datasiswa=a.data}))},i.getdatasiswa(),n.dataRapor={},n.dataRapork={},n.getharian=function(){$.blockUI({}),r.get("guru/pengetahuan/harian",(function(a){$.unblockUI({}),n.dataharian=[],n.datapilihan=[],n.datakomponen=a.komponen,n.datanilai=a.datanilai,n.datapas=a.datapas,n.dataRapor=a.datarapor,n.siswapilihan=a.siswapilihan,n.nilailock=a.nilailock,angular.forEach(n.datasiswa,(function(a){var o=!1;if("1"==n.datakelasSelect.mapel_pilihan&&(i.FilPilihan=n.siswapilihan.filter((function(i){return i.siswa_id==a.siswa_id})),i.FilPilihan.length>0&&(o=!0)),"0"==n.datakelasSelect.mapel_pilihan||1==o){var l=0,e="",t="",k=100;if(console.log("Paspat"),void 0!==n.datapas[a.siswa_id]?a.paspat=parseInt(n.datapas[a.siswa_id]):(a.paspat="",n.bobot.bobotkelas.paspat>0&&(k=0)),console.log(a.paspat),void 0!==n.datanilai[a.siswa_id]){a.nilai=n.datanilai[a.siswa_id];var p=0;angular.forEach(n.datakomponen,(function(i){var n;(n=void 0!==a.nilai[i.komponennilai_id]?parseInt(a.nilai[i.komponennilai_id]):0)>l&&(l=n,e=i.komponennilai_materi),n<k&&(k=n,t=i.komponennilai_materi),p+=n})),a.nilaiharian=Math.round(p/n.datakomponen.length,0)}else a.nilai=null,a.nilaiharian=0,n.bobot.bobotkelas.harian>0&&(k=0),n.bobot.bobotkelas.paspat>0&&(k=0);if(void 0!==n.dataRapor[a.siswa_id])a.rapor=n.dataRapor[a.siswa_id].rapor_nilai,a.predikat=n.dataRapor[a.siswa_id].rapor_predikat,a.desc=n.dataRapor[a.siswa_id].rapor_deskripsi;else if(a.nilaiharian+a.paspat>0?a.rapor=Math.round((a.nilaiharian*n.bobot.bobotkelas.harian+a.paspat*n.bobot.bobotkelas.paspat)/(n.bobot.bobotkelas.harian+n.bobot.bobotkelas.paspat),2):a.rapor=0,i.FilPredikat=n.kkmdata.kkmgrade.filter((function(i){return parseInt(i.kkmgrade_min)<=a.rapor&&parseInt(i.kkmgrade_max)>=a.rapor})),i.FilPredikat.length>0){a.predikat=i.FilPredikat[0].kkmgrade_kode;var r=parseInt(n.kkmdata.kkmtingkat_nilai),d="";d="A"==a.predikat?"sangat baik":"B"==a.predikat?"baik":"C"==a.predikat?"cukup baik":"belum optimal",r<=k&&r<=l&&r<=a.rapor?a.desc="Memiliki kemampuan "+d+" terutama kemampuan dalam "+e:r<=k&&r<=l&&r>a.rapor?a.desc=k==l?"Memiliki kemampuan "+d+" pada seluruh materi terutama dalam "+e:"Memiliki kemampuan "+d+". Memiliki kemampuan baik dalam "+e+", dan perlu ditingkatkan dalam "+t:a.desc=r>k&&k>0&&r<=l?k==l?"Memiliki kemampuan "+d+" pada seluruh materi terutama dalam "+t:"Memiliki kemampuan "+d+". Memiliki kemampuan baik dalam "+e+", dan perlu ditingkatkan dalam "+t:"Memiliki kemampuan belum optimal pada seluruh materi",0==a.rapor&&(a.desc="")}else a.predikat="-",a.desc="";console.log("Harian Siswa"),console.log(a),n.dataharian.push(a)}else a.select="0",n.datapilihan.push(a)}))}))},i.nilaikd=[],n.getketerampilan=function(){r.get("guru/keterampilan/dataketerampilan",(function(a){n.dataketerampilan=[],n.komponenuk=a.komponenuk,n.datauk=a.datauk,n.komponenpro=a.komponenpro,n.datapro=a.datapro,n.komponenpor=a.komponenpor,n.datapor=a.datapor,n.dataRapork=a.datarapork,n.siswapilihank=a.siswapilihan,angular.forEach(n.datasiswa,(function(a){var o=!1;if(i.nilaikd=[],i.finalkd=[],"1"==n.datakelasSelect.mapel_pilihan&&(i.FilPilihank=n.siswapilihank.filter((function(i){return i.siswa_id==a.siswa_id})),i.FilPilihank.length>0&&(o=!0)),"0"==n.datakelasSelect.mapel_pilihan||1==o){var l=0,e=100;if(a.uknilai=[],void 0!==n.datauk[a.siswa_id]){a.nilaiuk=n.datauk[a.siswa_id];var t=0;angular.forEach(n.komponenuk,(function(o){var k;void 0!==a.nilaiuk[o.komponennilai_id]?(k=parseInt(a.nilaiuk[o.komponennilai_id]),a.uknilai[o.komponennilai_nama]=k):(k=0,a.uknilai[o.komponennilai_nama]=0),n.bobot.bobotkelas.praktek>0&&(k>l&&(l=k),k<e&&(e=k)),null==i.nilaikd[o.komponennilai_nama]&&(i.nilaikd[o.komponennilai_nama]={},i.nilaikd[o.komponennilai_nama].nilai=0,i.nilaikd[o.komponennilai_nama].tnilai=0,i.nilaikd[o.komponennilai_nama].uk=0,i.nilaikd[o.komponennilai_nama].pro=0,i.nilaikd[o.komponennilai_nama].por=0),i.nilaikd[o.komponennilai_nama].komponennilai_materi=o.komponennilai_materi,i.nilaikd[o.komponennilai_nama].nama=o.komponennilai_nama,i.nilaikd[o.komponennilai_nama].tnilai++,i.nilaikd[o.komponennilai_nama].nilai+=k,i.nilaikd[o.komponennilai_nama].uk=k,t+=k})),a.uk=Math.round(t/n.komponenuk.length,0)}else a.nilaiuk=null,a.uk=0,n.bobot.bobotkelas.praktek>0&&(e=0);if(a.pronilai=[],void 0!==n.datapro[a.siswa_id]){a.nilaipro=n.datapro[a.siswa_id];var k=0;angular.forEach(n.komponenpro,(function(o){var t;void 0!==a.nilaipro[o.komponennilai_id]?(t=parseInt(a.nilaipro[o.komponennilai_id]),a.pronilai[o.komponennilai_nama]=t):(a.pronilai[o.komponennilai_nama]=0,t=0),n.bobot.bobotkelas.proyek>0&&(t>l&&(l=t,descmax=o.komponennilai_materi),t<e&&(e=t,descmin=o.komponennilai_materi)),null==i.nilaikd[o.komponennilai_nama]&&(i.nilaikd[o.komponennilai_nama]={},i.nilaikd[o.komponennilai_nama].nilai=0,i.nilaikd[o.komponennilai_nama].tnilai=0,i.nilaikd[o.komponennilai_nama].uk=0,i.nilaikd[o.komponennilai_nama].pro=0,i.nilaikd[o.komponennilai_nama].por=0),i.nilaikd[o.komponennilai_nama].komponennilai_materi=o.komponennilai_materi,i.nilaikd[o.komponennilai_nama].nama=o.komponennilai_nama,i.nilaikd[o.komponennilai_nama].nilai+=t,i.nilaikd[o.komponennilai_nama].pro=t,i.nilaikd[o.komponennilai_nama].tnilai++,k+=t})),a.pro=Math.round(k/n.komponenpro.length,0)}else a.nilaipro=null,a.pro=0,n.bobot.bobotkelas.proyek>0&&(e=0);if(a.pornilai=[],void 0!==n.datapor[a.siswa_id]){a.nilaipor=n.datapor[a.siswa_id];var p=0;angular.forEach(n.komponenpor,(function(o){var t;void 0!==a.nilaipor[o.komponennilai_id]?(t=parseInt(a.nilaipor[o.komponennilai_id]),a.pornilai[o.komponennilai_nama]=t):(a.pornilai[o.komponennilai_nama]=0,t=0),n.bobot.bobotkelas.porto>0&&(t>l&&(l=t,descmax=o.komponennilai_materi),t<e&&(e=t,descmin=o.komponennilai_materi)),null==i.nilaikd[o.komponennilai_nama]&&(i.nilaikd[o.komponennilai_nama]={},i.nilaikd[o.komponennilai_nama].nilai=0,i.nilaikd[o.komponennilai_nama].tnilai=0,i.nilaikd[o.komponennilai_nama].uk=0,i.nilaikd[o.komponennilai_nama].pro=0,i.nilaikd[o.komponennilai_nama].por=0),i.nilaikd[o.komponennilai_nama].komponennilai_materi=o.komponennilai_materi,i.nilaikd[o.komponennilai_nama].nama=o.komponennilai_nama,i.nilaikd[o.komponennilai_nama].nilai+=t,i.nilaikd[o.komponennilai_nama].por=t,i.nilaikd[o.komponennilai_nama].tnilai++,p+=t})),a.por=Math.round(p/n.komponenpor.length,0)}else a.nilaipor=null,a.por=0,n.bobot.bobotkelas.porto>0&&(e=0);if(console.log(i.nilaikd),a.finalkd=[],i.nilaikd.length>0){var r=0,d=0,m="",s="",u=100,_=0;angular.forEach(i.nilaikd,(function(n){d++,n.tnilai>0&&(n.nilaikd=n.nilai/n.tnilai,r+=n.nilai/n.tnilai,_<n.nilaikd&&(m=n.komponennilai_materi,_=n.nilaikd),u>n.nilaikd&&(s=n.komponennilai_materi,u=n.nilaikd)),i.finalkd.push(n),a.finalkd.push(n)})),console.log(i.finalkd),console.log(a.finalkd),a.rapork=Math.round(r/d,2)}else a.rapork=0;if(i.FilPredikat=n.kkmdata.kkmgrade.filter((function(i){return parseInt(i.kkmgrade_min)<=a.rapork&&parseInt(i.kkmgrade_max)>=a.rapork})),i.FilPredikat.length>0){a.predikatk=i.FilPredikat[0].kkmgrade_kode;parseInt(n.kkmdata.kkmtingkat_nilai);var c="";c="A"==a.predikatk?"Sangat terampil terutama dalam "+m:"B"==a.predikatk?"Terampil terutama dalam "+m:"C"==a.predikatk?"Cukup terampil terutama dalam "+m:u>0?"Kurang terampil terutama dalam "+s:"Kurang terampil terutama dalam "+m,a.desck=c,0==a.rapork&&(a.desck="")}else a.predikatk="-";void 0!==n.dataRapork[a.siswa_id]&&(a.rapork=n.dataRapork[a.siswa_id].rapor_nilai,a.predikatk=n.dataRapork[a.siswa_id].rapor_predikat,a.desck=n.dataRapork[a.siswa_id].rapor_deskripsi),console.log(a),n.dataketerampilan.push(a),console.log(i.dtInstance)}}))}))}}]);